{
    "collab_server" : "",
    "contents" : "---\ntitle: \"The relationship between restaurant geographical distribution and chronic disease outcomes in New York City\"\noutput: \n  flexdashboard::flex_dashboard:\n    orientation: columns\n    vertical_layout: fill\n---\n\n```{r setup, include=FALSE}\nlibrary(tidyverse)\nlibrary(rvest)\nlibrary(httr)\nlibrary(readxl)\nlibrary(data.table)\nlibrary(stringr)\nlibrary(janitor)\nlibrary(stringr)\nlibrary(forcats)\nlibrary(jsonlite)\nlibrary(viridis)\nlibrary(plotly)\nlibrary(ggplot2)\nlibrary(knitr)\n```\n\n```{r New_York_Inspection_data, include=FALSE}\nget_all_inspections = function(url) {\n  \n  all_inspections = vector(\"list\", length = 0)\n  \n  loop_index = 1\n  chunk_size = 50000\n  DO_NEXT = TRUE\n  \n  while (DO_NEXT) {\n    message(\"Getting data, page \", loop_index)\n    \n    all_inspections[[loop_index]] = \n      GET(url,\n          query = list(`$order` = \"zipcode\",\n                       `$limit` = chunk_size,\n                       `$offset` = as.integer((loop_index - 1) * chunk_size)\n                       )\n          ) %>%\n      content(\"text\") %>%\n      fromJSON() %>%\n      as_tibble()\n    \n    DO_NEXT = dim(all_inspections[[loop_index]])[1] == chunk_size\n    loop_index = loop_index + 1\n  }\n  \n  all_inspections\n  \n}\n\nurl = \"https://data.cityofnewyork.us/resource/9w7m-hzhe.json\"\n\nrest_inspection = get_all_inspections(url) %>%\n  bind_rows() \n```\n\n```{r health_data, include=FALSE}\ndownload.file(\"https://www1.nyc.gov/assets/doh/downloads/excel/episrv/2015_CHP_PUD.xlsx\", mode=\"wb\", destfile = \"health.xlsx\")\nhealth <- read_excel(\"health.xlsx\", sheet = \"CHP_all_data\") %>% \n  select(Name, Racewhite_Rate, Poverty, Unemployment,\n         Smoking, Exercise,\n         Obesity, Diabetes, Stroke_Hosp) %>% \n  clean_names() \n```\n\n```{r neighborhood_restaurant, include=FALSE}\nzip_neighbor <- read_csv(\"neigh_zipcode.csv\") %>% \n  mutate(zipcode = as.character(zipcode))\n##restaurant data with neighbourhood\nrest_neighborhood = left_join(rest_inspection, zip_neighbor, by = \"zipcode\") %>% \n  filter(!is.na(neighborhood))\n```\n\n\nColumn {data-width=500}\n-----------------------------------------------------------------------\n\n### Obesity, diabetes prevalences and rate of stroke hospitalizations per 100,000 adults (n= 59)\n\n```{r neighborhood_health}\nhealth_outcome <- health[-c(1:6),] %>% \n  rename(neighborhood = name) %>% \n  mutate(neighborhood = as.factor(neighborhood)) %>% \n  select(neighborhood,obesity,diabetes,stroke_hosp) %>% \n  gather(key = outcomes, value = rate, obesity:stroke_hosp) \n\n##Plotting box plot for neighborhood outcomes \nboxplot_ob_dia <- health_outcome %>% \n  rename(percentage = rate) %>% \n  filter(outcomes == c(\"obesity\",\"diabetes\")) %>% \n  ggplot(aes(x = outcomes, y = percentage)) + geom_boxplot() + \n  geom_point(aes(color = neighborhood)) + theme(legend.position = \"none\") +\n  labs(title = \"Percentage of diabetes and obesity\")\n\nplotly_ob_dia <- ggplotly(boxplot_ob_dia)\n\nboxplot_stroke <- health_outcome %>% \n  filter(outcomes == \"stroke_hosp\") %>% \n  ggplot(aes(x = outcomes, y = rate)) + geom_boxplot() + \n  geom_point(aes(color = neighborhood)) + theme(legend.position = \"none\")\n\nplotly_stroke <- ggplotly(boxplot_stroke)\n\nsubplot(hide_legend(plotly_ob_dia),hide_legend(plotly_stroke))\n```\n\n### Number of fastfood and non-fastfood restaurants in each neighborhood (n= 59)\n\n```{r calculating_percentage}\nneighborhood_list = \n  rest_neighborhood %>%\n  distinct(neighborhood) %>%\n  arrange(neighborhood)\n  \nrest_fastfood_neighborhood = \n  rest_neighborhood %>%\n  filter(cuisine_description %in% c(\"Bagels/Pretzels\",\n                                    \"Bottled beverages, including water, sodas, juices, etc.\",\n                                    \"Chicken\",\n                                    \"Delicatessen\",\n                                    \"Donuts\",\n                                    \"Hamburgers\",\n                                    \"Hotdogs\",\n                                    \"Hotdogs/Pretzels\",\n                                    \"Ice Cream, Gelato, Yogurt, Ices\",\n                                    \"Nuts/Confectionary\",\n                                    \"Pancakes/Waffles\",\n                                    \"Pizza\",\n                                    \"Soul Food\",\n                                    \"Sandwiches\",\n                                    \"Sandwiches/Salads/Mixed Buffet\",\n                                    \"Soups & Sandwiches\"))\n\npercent_fastfood_neighborhood = function(name_neighborhood){\n\n  rest_each_neighborhood =\n    rest_neighborhood %>%\n    filter(neighborhood == name_neighborhood) %>%\n    distinct(camis)\n  \n  n_rest_neighborhood = nrow(rest_each_neighborhood)\n\n  rest_fastfood_distinct_neighborhood = \n    rest_fastfood_neighborhood %>%\n    filter(neighborhood == name_neighborhood) %>%\n    distinct(camis, cuisine_description)\n  \n  n_fastfood_neighborhood = nrow(rest_fastfood_distinct_neighborhood)\n    \n  percent_fastfood_neighborhood = n_fastfood_neighborhood/n_rest_neighborhood\n  \n  tibble(\n    neighborhood = name_neighborhood,\n    n_fastfood = n_fastfood_neighborhood,\n    n_rest = n_rest_neighborhood,\n    percent_fastfood = percent_fastfood_neighborhood\n  )\n}\n\nneighborhood_boro = \n  rest_neighborhood %>%\n  distinct(neighborhood, boro) %>%\n  arrange(neighborhood) %>%\n  mutate(neighborhood = str_to_upper(neighborhood)) %>%\n  filter(!(neighborhood == \"LONG ISLAND CITY AND ASTORIA\" & boro == \"MANHATTAN\"))\n\nfastfood_neighborhood = \n  map(neighborhood_list$neighborhood, percent_fastfood_neighborhood) %>%\n  bind_rows() %>%\n  mutate(neighborhood = str_to_upper(neighborhood)) %>%\n  left_join(., neighborhood_boro, by = \"neighborhood\")\n  \n# plot for each neighborhood\nfastfood_neighborhood %>%\n  mutate(neighborhood = as.factor(neighborhood),\n         n_rest = as.numeric(n_rest),\n         n_nonfastfood = n_rest - n_fastfood,\n         neighborhood = fct_reorder(neighborhood, percent_fastfood),\n         text_label = str_c(\"Neighborhood: \", neighborhood, '\\nPercentage: ', format(percent_fastfood * 100, digits = 3), \"%\")) %>%\n  plot_ly(., x = ~neighborhood, y = ~n_fastfood, type = 'bar', name = 'fastfood restaurants', text = ~text_label) %>%\n  add_trace(y = ~n_nonfastfood, name = 'non-fastfood restaurants') %>%\n  layout(title = \"Neighborhoods ordered by percentage of fastfood restaurants\",\n         yaxis = list(title = 'Number of restaurants'), \n         xaxis = list(title = 'NYC Neighborhood',\n                      showticklabels = FALSE),\n         barmode = 'stack')\n```\n\nColumn {data-width=500}\n-----------------------------------------------------------------------\n\n```{r getting_data_ready_for_analysis, include = FALSE}\nhealth_neighborhood = \n  health %>%\n  mutate(neighborhood = str_to_upper(name)) %>%\n  select(-name)\n\ncombined_fastfood = \n  fastfood_neighborhood %>%\n  mutate(fastfood_percent = percent_fastfood) %>%\n  select(neighborhood, fastfood_percent)\n\ncombined_model =  \n  left_join(combined_fastfood, health_neighborhood, by = \"neighborhood\")\n```\n\n\n```{r, include = FALSE}\nlibrary(broom)\ncombined_model_percent <- combined_model %>%  mutate(obesity_percent = obesity/100,\n                                                     diabetes_percent = diabetes/100,\n                                                     stroke_hosp_percent = stroke_hosp/100)\n```\n\n### Scatterplot between obesity prevalence and percent of fastfood restaurants for neighborhoods (n=59)\n\n```{r}\nm <- lm(obesity_percent ~ fastfood_percent, data = combined_model_percent)\nplot1 <- broom::augment(m) %>% \n  plot_ly(x = ~fastfood_percent) %>%\n  add_markers(y = ~obesity_percent , color = I(\"red\"), showlegend = FALSE) %>%\n  add_ribbons(ymin = ~.fitted - 1.96 * .se.fit, \n              ymax = ~.fitted + 1.96 * .se.fit, color = I(\"gray80\"),\n              name = \"95% confidence\") %>%\n  add_lines(y = ~.fitted, color = I(\"steelblue\"), name = \"obesity_percent\")\nplot1\n```\n\n### Scatterplot between diabetes prevalence and percent of fastfood restaurants for neighborhoods (n=59)\n\n```{r}\nn <- lm(diabetes_percent ~ fastfood_percent, data = combined_model_percent)\nplot2 <- broom::augment(n) %>% \n  plot_ly(x = ~fastfood_percent) %>%\n  add_markers(y = ~diabetes_percent, color = I(\"yellow\"), showlegend = FALSE) %>%\n  add_ribbons(ymin = ~.fitted - 1.96 * .se.fit, \n              ymax = ~.fitted + 1.96 * .se.fit, color = I(\"gray80\"),\n              name = \"95% confidence\") %>%\n  add_lines(y = ~.fitted, color = I(\"steelblue\"),name = \"diabetes_percent\")\nplot2\n```\n\n### Scatterplot between stroke hospitalization rates (per 100,000 adults) prevalence and percent of fastfood restaurants for neighborhoods (n=59)\n\n```{r}\no <- lm(stroke_hosp_percent ~ fastfood_percent, data = combined_model_percent)\nplot3 <- broom::augment(o) %>% \n  plot_ly(x = ~fastfood_percent) %>%\n  add_markers(y = ~stroke_hosp_percent, color = I(\"blue\"), showlegend = FALSE) %>%\n  add_ribbons(ymin = ~.fitted - 1.96 * .se.fit, \n              ymax = ~.fitted + 1.96 * .se.fit, color = I(\"gray80\"),\n              name = \"95% confidence\") %>%\n  add_lines(y = ~.fitted, color = I(\"steelblue\"),name = \"stroke_hosp_percent\")\nplot3\n```\n\n\n\n",
    "created" : 1512518230107.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "473747931",
    "id" : "FB799EE9",
    "lastKnownWriteTime" : 1512704895,
    "last_content_update" : 1512704895,
    "path" : "~/Desktop/Columbia/semester 1/Data Science I/<DSFinalWebsite>.github.io/dashboard.Rmd",
    "project_path" : "dashboard.Rmd",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 4,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}